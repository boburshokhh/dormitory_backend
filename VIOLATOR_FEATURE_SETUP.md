# Настройка функции нарушителей

## Описание

Добавлена возможность отмечать студентов как нарушителей в системе управления общежитием. Нарушители выделяются визуально в списках заявок.

## Изменения в базе данных

### Миграция

Файл: `migrations/add_violator_status_to_users.sql`

Добавляет:

- Поле `is_violator BOOLEAN DEFAULT false` в таблицу `users`
- Индекс `idx_users_is_violator` для быстрого поиска
- Комментарий к полю

### Запуск миграции

```bash
cd dormitory-backend
node scripts/run-violator-migration.js
```

## Изменения в API

### Новые endpoints

#### 1. Обновление статуса нарушителя

```
PATCH /api/users/:id/violator
```

**Параметры:**

- `id` (UUID) - ID пользователя
- `is_violator` (boolean) - новый статус

**Пример запроса:**

```json
{
  "is_violator": true
}
```

**Ответ:**

```json
{
  "message": "Пользователь отмечен как нарушитель",
  "user": {
    "id": "uuid",
    "isViolator": true,
    "updatedAt": "2024-12-19T10:00:00Z"
  }
}
```

#### 2. Обновленная статистика пользователей

```
GET /api/users/stats
```

**Новое поле в ответе:**

```json
{
  "roleStats": { ... },
  "totalUsers": 100,
  "totalActive": 95,
  "totalInactive": 5,
  "violatorsCount": 3
}
```

#### 3. Фильтрация пользователей

```
GET /api/users?is_violator=true
```

**Новые параметры:**

- `is_violator=true` - только нарушители
- `is_violator=false` - только не нарушители
- `is_violator` не указан - все пользователи

### Обновленные endpoints

#### 1. Список заявок

```
GET /api/applications
```

**Новое поле в ответе:**

```json
{
  "student": {
    "firstName": "Иван",
    "lastName": "Иванов",
    "isViolator": true,
    ...
  }
}
```

## Изменения во фронтенде

### Новые компоненты

#### 1. UsersView.vue

- Таблица пользователей с фильтрацией
- Кнопки для отметки нарушителей
- Пагинация
- Мобильная адаптация

#### 2. Обновленный AdminDashboardView.vue

- Блок управления пользователями
- Статистика нарушителей

#### 3. Обновленный ApplicationsView.vue

- Желтая подсветка заявок от нарушителей
- Значки "Нарушитель" рядом с ФИО

### Новые сервисы

#### usersService.js

```javascript
// Получить пользователей с фильтрацией
getUsers(params)

// Обновить статус нарушителя
updateViolatorStatus(userId, isViolator)

// Получить статистику
getStats()
```

## Навигация

### Добавлены ссылки в:

- AppHeader.vue - "Пользователи"
- MobileMenu.vue - "Пользователи"
- AdminDashboardView.vue - блок управления

## Визуальные индикаторы

### В списке пользователей:

- Желтый фон для нарушителей
- Красный значок "Нарушитель"
- Кнопки "Нарушитель"/"Снять метку"

### В списке заявок:

- Желтый фон строки
- Желтая граница слева
- Красный значок "Нарушитель"

## Безопасность

### Права доступа:

- Только админы и супер-админы могут управлять нарушителями
- Только студенты могут быть отмечены как нарушители
- Все действия логируются

### Валидация:

- Проверка существования пользователя
- Проверка роли пользователя
- Валидация UUID

## Тестирование

### Проверка миграции:

```bash
node scripts/run-violator-migration.js
```

### Проверка API:

```bash
# Получить статистику
curl -H "Authorization: Bearer TOKEN" http://localhost:3000/api/users/stats

# Отметить нарушителем
curl -X PATCH -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"is_violator": true}' \
  http://localhost:3000/api/users/USER_ID/violator
```

## Производительность

### Индексы:

- `idx_users_is_violator` - для быстрого поиска нарушителей
- Существующие индексы для JOIN операций

### Оптимизации:

- Пагинация на сервере
- Фильтрация на уровне БД
- Кэширование статистики

## Совместимость

### Обратная совместимость:

- Поле `is_violator` имеет значение по умолчанию `false`
- Существующие API продолжают работать
- Новые поля опциональны в ответах

### Миграция данных:

- Существующие пользователи не затронуты
- Новое поле добавляется без потери данных
