# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è

## –ü—Ä–æ–±–ª–µ–º–∞

```
‚ùå SQL Error: there is no unique or exclusion constraint matching the ON CONFLICT specification
```

## –ü—Ä–∏—á–∏–Ω–∞

–í —Ç–∞–±–ª–∏—Ü–µ `verification_codes` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ –ø–æ–ª—è–º `(contact, type)`, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã `ON CONFLICT` –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö.

## –†–µ—à–µ–Ω–∏–µ

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL-–º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ë–î PostgreSQL –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
psql -h 192.168.1.253 -U postgres -d gubkin_dormitory -f migrations/fix_verification_codes_unique_constraint.sql
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:

```sql
-- 1. –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
DELETE FROM verification_codes
WHERE id NOT IN (
    SELECT DISTINCT ON (contact, type) id
    FROM verification_codes
    ORDER BY contact, type, created_at DESC
);

-- 2. –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
CREATE UNIQUE INDEX IF NOT EXISTS verification_codes_contact_type_unique
ON verification_codes (contact, type);
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä (Ctrl+C)
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
npm start
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
- Email –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è, –∫–æ–¥ –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ –ë–î –±–µ–∑ –æ—à–∏–±–æ–∫

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –∫–æ–¥–µ

### Backend (–Ω–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã):

- `GET /auth/check-email?email=...` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è email
- `POST /auth/forgot-password { email }` - –∑–∞–ø—Ä–æ—Å –∫–æ–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
- `POST /auth/reset-password-by-code { code, email }` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞ –∏ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è (–±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)

### Frontend:

- –£–ø—Ä–æ—â–µ–Ω–∞ –º–æ–¥–∞–ª–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è: email ‚Üí –∫–æ–¥ ‚Üí —É—Å–ø–µ—Ö
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è email –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å —Å–µ—Ä–≤–µ—Ä–∞

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ email:

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç email
- –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `GET /auth/check-email`
- –ï—Å–ª–∏ email –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Üí –æ—à–∏–±–∫–∞ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω"
- –ï—Å–ª–∏ email –Ω–∞–π–¥–µ–Ω ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞

### 2. –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞:

- –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥ –Ω–∞ email —á–µ—Ä–µ–∑ `POST /auth/forgot-password`
- –ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î —Å —Ç–∏–ø–æ–º `password_reset`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ

### 3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞:

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥
- –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ —á–µ—Ä–µ–∑ `POST /auth/reset-password-by-code`
- –ü—Ä–∏ —É—Å–ø–µ—Ö–µ: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ email, –∫–æ–¥ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –ë–î

## –õ–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ–π —Ä–∞–±–æ—Ç—ã

```
‚úÖ Email –Ω–∞–π–¥–µ–Ω: user@example.com
üìß –ö–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ user@example.com
üî¢ –ö–æ–¥ –≤ –ø–∏—Å—å–º–µ: 123456
‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è user@example.com
```
