# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –≤ MinIO

## –ü—Ä–æ–±–ª–µ–º–∞

–†–∞–Ω–µ–µ –≤ —Å–∏—Å—Ç–µ–º–µ —Ñ–∞–π–ª–æ–≤ –±—ã–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º - –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª –º–æ–≥ –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑, —Å–æ–∑–¥–∞–≤–∞—è –¥—É–±–ª–∏–∫–∞—Ç—ã –≤ MinIO –∏ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

### –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã

–í —Ñ–∞–π–ª–µ `backend/routes/files.js` –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –±—ã–ª–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π:

```javascript
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ —Å—Ä–µ–¥–∏ —Ñ–∞–π–ª–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'active'
const existingFile = await query(
  `SELECT id, file_name FROM files 
   WHERE user_id = $1 AND file_hash = $2 AND file_type = $3 AND status = 'active'`,
  [req.user.id, fileHash, fileType],
)
```

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–ª–æ, —á—Ç–æ —Ñ–∞–π–ª—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `'uploading'` (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã) –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### 1. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

```javascript
// –ü–†–ê–í–ò–õ–¨–ù–û - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–µ–¥–∏ —Ñ–∞–π–ª–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ 'active' –∏ 'uploading'
const existingFile = await query(
  `SELECT id, file_name, status FROM files 
   WHERE user_id = $1 AND file_hash = $2 AND file_type = $3 AND status IN ('active', 'uploading') AND deleted_at IS NULL`,
  [req.user.id, fileHash, fileType],
)
```

### 2. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤

```javascript
if (existingFile.rows.length > 0) {
  const existingFileData = existingFile.rows[0]
  const fileUrl = await getFileUrl(existingFileData.file_name)

  uploadResults.push({
    id: existingFileData.id,
    originalName: file.originalname,
    url: fileUrl,
    status: existingFileData.status,
    message: existingFileData.status === 'active'
      ? '–§–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
      : '–§–∞–π–ª —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏',
  })

  console.log(`üìã –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª: ${existingFileData.file_name} (—Å—Ç–∞—Ç—É—Å: ${existingFileData.status})`)
  continue
}
```

### 3. –ù–æ–≤—ã–π endpoint –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π endpoint `POST /api/files/cleanup-duplicates` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:

```javascript
router.post('/cleanup-duplicates', async (req, res) => {
  // –ü–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π SQL
  const duplicates = await query(
    `WITH ranked_files AS (
      SELECT 
        id, file_name, original_name, user_id, file_hash, file_type, created_at, status,
        ROW_NUMBER() OVER (PARTITION BY user_id, file_hash, file_type ORDER BY created_at ASC) as rn
      FROM files 
      WHERE status IN ('active', 'uploading') AND deleted_at IS NULL
    )
    SELECT * FROM ranked_files WHERE rn > 1`,
  )

  // –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–∞–º—ã–π –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª)
  // ...
})
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
npm run test:duplicates

# –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤
npm run test:all
```

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è

1. **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**: –ó–∞–≥—Ä—É–∑–∫–∞ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞ –¥–≤–∞–∂–¥—ã –Ω–µ –¥–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î**: –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∞–π–ª —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º —Ö–µ—à–µ–º
3. **–†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤**: –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª –º–æ–∂–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏

### –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞

```javascript
// –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –ø–µ—Ä–≤—ã–π —Ä–∞–∑
const firstUpload = await uploadFile(token, testFile, 'document')

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª –≤—Ç–æ—Ä–æ–π —Ä–∞–∑
const secondUpload = await uploadFile(token, testFile, 'document')

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ ID —Ñ–∞–π–ª–æ–≤ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ (–¥—É–±–ª–∏–∫–∞—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω)
const isDuplicated = firstUpload.uploaded[0].id !== secondUpload.uploaded[0].id
```

## –û—á–∏—Å—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

–î–ª—è –æ—á–∏—Å—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```bash
# –ß–µ—Ä–µ–∑ API (—Ç—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
curl -X POST http://localhost:3000/api/files/cleanup-duplicates \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

## –°—Ç–∞—Ç—É—Å—ã —Ñ–∞–π–ª–æ–≤

- `'uploading'` - —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –µ—â–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (–≤—Ä–µ–º–µ–Ω–Ω—ã–π)
- `'active'` - —Ñ–∞–π–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
- `'deleted'` - —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω (–º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ)

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞**: –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Ö–µ—à —Ñ–∞–π–ª–∞
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤**: –ò—â–µ—Ç—Å—è —Ñ–∞–π–ª —Å —Ç–∞–∫–∏–º –∂–µ —Ö–µ—à–µ–º, —Ç–∏–ø–æ–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
3. **–ï—Å–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç –Ω–∞–π–¥–µ–Ω**: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
4. **–ï—Å–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω**: –°–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `'uploading'`
5. **–ê–∫—Ç–∏–≤–∞—Ü–∏—è**: –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–≤–æ–¥—è—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å `'active'`

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```sql
-- –ü–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ –ë–î
WITH ranked_files AS (
  SELECT
    id, file_name, original_name, user_id, file_hash, file_type, created_at, status,
    ROW_NUMBER() OVER (PARTITION BY user_id, file_hash, file_type ORDER BY created_at ASC) as rn
  FROM files
  WHERE status IN ('active', 'uploading') AND deleted_at IS NULL
)
SELECT * FROM ranked_files WHERE rn > 1;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ñ–∞–π–ª–∞–º
SELECT
  status,
  COUNT(*) as count,
  SUM(file_size) as total_size
FROM files
WHERE deleted_at IS NULL
GROUP BY status;
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤. –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –≤ MinIO –∏ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
