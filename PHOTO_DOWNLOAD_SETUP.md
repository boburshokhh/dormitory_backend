# Настройка скачивания фотографий студентов

## Обзор изменений

Данный документ описывает изменения, внесенные для реализации функциональности скачивания фотографий 3x4 студентов в системе управления общежитием.

## Изменения в бэкенде

### 1. Обновление запроса списка заявок (`utils/queryBuilder.js`)

**Файл:** `dormitory-backend/utils/queryBuilder.js`

**Изменения:**

- Добавлен `student_id` в основные данные студента
- Добавлено поле `avatar_file_name` через LEFT JOIN с таблицей files
- Переименован алиас `f` в подзапросе социальной защиты на `f_social` для избежания конфликтов

```sql
-- Добавлено в SELECT:
u.id as student_id,
f.file_name as avatar_file_name,

-- Добавлено в FROM:
LEFT JOIN files f ON u.avatar_file_id = f.id AND f.status = 'active' AND f.deleted_at IS NULL
```

### 2. Обновление форматирования данных (`services/applicationsService.js`)

**Файл:** `dormitory-backend/services/applicationsService.js`

**Изменения:**

- В функции `formatApplicationListItem()` добавлены поля:
  - `id: app.student_id` - ID студента
  - `avatar_file_name: app.avatar_file_name` - имя файла аватара

### 3. Новый эндпоинт для получения фотографий (`controllers/applicationsController.js`)

**Файл:** `dormitory-backend/controllers/applicationsController.js`

**Новый метод:** `getStudentPhotos()`

**Эндпоинт:** `GET /api/applications/photos`

**Функциональность:**

- Принимает те же фильтры, что и основной список заявок
- Возвращает студентов, разделенных на две группы:
  - `studentsWithPhotos` - студенты с загруженными фотографиями
  - `studentsWithoutPhotos` - студенты без фотографий
- Для каждого студента с фотографией формирует правильный URL через `getFileUrl()`

### 4. Добавление роута (`routes/applications.js`)

**Файл:** `dormitory-backend/routes/applications.js`

**Новый роут:**

```javascript
// GET /api/applications/photos - Получить фотографии студентов (только админы)
router.get('/photos', requireAdmin, applicationsController.getStudentPhotos)
```

## Изменения во фронтенде

### 1. Исправление функции скачивания отдельного фото

**Файл:** `src/views/admin/ApplicationsView.vue`

**Функция:** `downloadStudentPhoto()`

**Изменения:**

- Запрос данных студента через API `/users/${student.id}`
- Использование базового URL: `https://files.dormitory.gubkin.uz/upload/${avatar_file_name}`
- Улучшенная обработка ошибок

### 2. Исправление функции массового скачивания

**Функция:** `downloadPhotosArchive()`

**Изменения:**

- Использование нового эндпоинта `/applications/photos` вместо несуществующего
- Получение готовых данных о студентах с фотографиями и без них
- Прямое использование данных от API без дополнительной обработки

## Структура URL фотографий

### Базовый URL

```
https://files.dormitory.gubkin.uz/upload/
```

### Формат файла

Из примера URL: `https://files.dormitory.gubkin.uz/upload/photo_3x4/9e9e6760-a3b1-45ef-a282-2f3b15a8f66a/1756361378359-rillyu.jpg`

**Структура:**

- Базовый URL + путь файла
- Путь файла хранится в поле `avatar_file_name` в таблице `files`

### Формирование URL

Бэкенд использует функцию `getFileUrl()` из `config/fileStorage.js` для правильного формирования URL.

## Тестирование

### 1. Тестирование отдельного скачивания

1. Открыть страницу заявок в админ-панели
2. Нажать на кнопку скачивания фото рядом с любой заявкой
3. Проверить, что файл скачивается с правильным именем (ФИО студента)

### 2. Тестирование массового скачивания

1. Применить необходимые фильтры
2. Нажать кнопку "Архив фото"
3. Проверить, что создается архив с фотографиями и отчетом

### 3. Проверка API эндпоинта

```bash
# Тест нового эндпоинта (требуется авторизация админа)
GET /api/applications/photos?status=submitted&course=1
```

## Возможные проблемы и решения

### 1. Фотография не найдена

**Причина:** Файл не существует или неправильный URL
**Решение:** Проверить существование файла в поле `avatar_file_name` и правильность формирования URL

### 2. Ошибка доступа 403

**Причина:** Проблемы с CORS или доступом к файловому серверу
**Решение:** Проверить настройки CORS на файловом сервере

### 3. Пустой список студентов с фотографиями

**Причина:** Нет студентов с заполненным `avatar_file_id` или проблемы с JOIN
**Решение:** Проверить данные в базе и корректность JOIN запроса

## Логирование

Все операции логируются через стандартную систему логирования:

- Успешные запросы к эндпоинту `/applications/photos`
- Ошибки формирования URL
- Ошибки скачивания файлов

## Безопасность

- Эндпоинт `/applications/photos` доступен только администраторам
- Все файлы проверяются на статус 'active' и отсутствие `deleted_at`
- Используется стандартная аутентификация через токены
